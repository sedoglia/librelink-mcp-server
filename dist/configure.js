#!/usr/bin/env node
/**
 * CLI Configuration Tool for LibreLink MCP Server
 *
 * Usage: npm run configure
 */
import * as readline from 'readline';
import { ConfigManager } from './config.js';
import { LibreLinkClient } from './librelink-client.js';
const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});
function question(prompt) {
    return new Promise((resolve) => {
        rl.question(prompt, (answer) => {
            resolve(answer.trim());
        });
    });
}
function questionHidden(prompt) {
    return new Promise((resolve) => {
        process.stdout.write(prompt);
        const stdin = process.stdin;
        const wasRaw = stdin.isRaw;
        if (stdin.isTTY) {
            stdin.setRawMode(true);
        }
        let password = '';
        const onData = (char) => {
            const c = char.toString('utf8');
            switch (c) {
                case '\n':
                case '\r':
                case '\u0004':
                    if (stdin.isTTY) {
                        stdin.setRawMode(wasRaw);
                    }
                    stdin.removeListener('data', onData);
                    console.log('');
                    resolve(password);
                    break;
                case '\u0003':
                    process.exit();
                    break;
                case '\u007F':
                case '\b':
                    password = password.slice(0, -1);
                    break;
                default:
                    password += c;
                    process.stdout.write('*');
                    break;
            }
        };
        stdin.on('data', onData);
        stdin.resume();
    });
}
async function main() {
    console.log('');
    console.log('ðŸ©¸ LibreLink MCP Server Configuration');
    console.log('=====================================');
    console.log('');
    console.log('This tool will configure your LibreLink credentials.');
    console.log('Your credentials are stored locally at ~/.librelink-mcp/config.json');
    console.log('');
    console.log('âš ï¸  IMPORTANT: Use your LibreLinkUp credentials (not LibreLink)');
    console.log('   - LibreLinkUp is the follower/sharing app');
    console.log('   - Make sure data sharing is enabled in the LibreLink app');
    console.log('');
    const configManager = new ConfigManager();
    const currentConfig = configManager.getConfig();
    // Get email
    const emailPrompt = currentConfig.email
        ? `Email [${currentConfig.email}]: `
        : 'Email: ';
    let email = await question(emailPrompt);
    if (!email && currentConfig.email) {
        email = currentConfig.email;
    }
    if (!email) {
        console.log('âŒ Email is required');
        rl.close();
        process.exit(1);
    }
    // Get password
    console.log('');
    const password = await questionHidden('Password: ');
    if (!password) {
        console.log('âŒ Password is required');
        rl.close();
        process.exit(1);
    }
    // Get region
    console.log('');
    console.log('Region options:');
    console.log('  EU - Europe (default)');
    console.log('  US - United States');
    console.log('  DE - Germany');
    console.log('  FR - France');
    console.log('  AP - Asia Pacific');
    console.log('  AU - Australia');
    console.log('');
    const regionPrompt = `Region [${currentConfig.region}]: `;
    let region = (await question(regionPrompt)).toUpperCase();
    if (!region) {
        region = currentConfig.region;
    }
    const validRegions = ['EU', 'US', 'DE', 'FR', 'AP', 'AU'];
    if (!validRegions.includes(region)) {
        console.log(`âŒ Invalid region. Must be one of: ${validRegions.join(', ')}`);
        rl.close();
        process.exit(1);
    }
    // Get target ranges
    console.log('');
    console.log('Target glucose ranges (mg/dL):');
    const lowPrompt = `Target Low [${currentConfig.targetLow}]: `;
    const lowInput = await question(lowPrompt);
    const targetLow = lowInput ? parseInt(lowInput, 10) : currentConfig.targetLow;
    const highPrompt = `Target High [${currentConfig.targetHigh}]: `;
    const highInput = await question(highPrompt);
    const targetHigh = highInput ? parseInt(highInput, 10) : currentConfig.targetHigh;
    if (targetLow >= targetHigh) {
        console.log('âŒ Target low must be less than target high');
        rl.close();
        process.exit(1);
    }
    // Save configuration
    console.log('');
    console.log('Saving configuration...');
    try {
        configManager.updateCredentials(email, password);
        configManager.updateRegion(region);
        configManager.updateRanges(targetLow, targetHigh);
        console.log(`âœ… Configuration saved to ${configManager.getConfigPath()}`);
    }
    catch (error) {
        console.log(`âŒ Failed to save configuration: ${error}`);
        rl.close();
        process.exit(1);
    }
    // Test connection
    console.log('');
    console.log('Testing connection to LibreLinkUp...');
    try {
        const client = new LibreLinkClient(configManager.getConfig());
        await client.validateConnection();
        console.log('âœ… Connection successful!');
        const glucose = await client.getCurrentGlucose();
        console.log('');
        console.log('Current glucose reading:');
        console.log(`  Value: ${glucose.value} mg/dL`);
        console.log(`  Trend: ${glucose.trend}`);
        console.log(`  Status: ${glucose.color === 'green' ? 'In Range' : glucose.color === 'red' ? 'Critical' : 'Out of Range'}`);
    }
    catch (error) {
        console.log(`âŒ Connection failed: ${error}`);
        console.log('');
        console.log('Troubleshooting:');
        console.log('  1. Verify your email and password are correct');
        console.log('  2. Make sure you are using LibreLinkUp credentials');
        console.log('  3. Open the LibreLinkUp app and accept any Terms & Conditions');
        console.log('  4. Ensure someone is sharing data with you (or share your own data)');
        console.log('  5. Check that your region setting is correct');
        rl.close();
        process.exit(1);
    }
    console.log('');
    console.log('ðŸŽ‰ Configuration complete!');
    console.log('');
    console.log('Next steps:');
    console.log('  1. Add the server to Claude Desktop configuration');
    console.log('  2. Restart Claude Desktop');
    console.log('  3. Ask Claude about your glucose levels!');
    rl.close();
}
main().catch((error) => {
    console.error('Error:', error);
    process.exit(1);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlndXJlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbmZpZ3VyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUE7Ozs7R0FJRztBQUVILE9BQU8sS0FBSyxRQUFRLE1BQU0sVUFBVSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDNUMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRXhELE1BQU0sRUFBRSxHQUFHLFFBQVEsQ0FBQyxlQUFlLENBQUM7SUFDbEMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxLQUFLO0lBQ3BCLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTTtDQUN2QixDQUFDLENBQUM7QUFFSCxTQUFTLFFBQVEsQ0FBQyxNQUFjO0lBQzlCLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtRQUM3QixFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQzdCLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLE1BQWM7SUFDcEMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQzdCLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTdCLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFDNUIsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUUzQixJQUFJLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNoQixLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3pCLENBQUM7UUFFRCxJQUFJLFFBQVEsR0FBRyxFQUFF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QUUsQ0FBQyxDQUFDO0lBQ2hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDM0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxREFBcUQsQ0FBQyxDQUFDO0lBQ25FLE9BQU8sQ0FBQyxHQUFHLENBQUMsNkJBQTZCLENBQUMsQ0FBQztJQUMzQyxPQUFPLENBQUMsR0FBRyxDQUFDLDRDQUE0QyxDQUFDLENBQUM7SUFFMUQsRUFBRSxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ2IsQ0FBQztBQUVELElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO0lBQ3JCLE9BQU8sQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQy9CLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbEIsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIjIS91c3IvYmluL2VudiBub2RlXG5cbi8qKlxuICogQ0xJIENvbmZpZ3VyYXRpb24gVG9vbCBmb3IgTGlicmVMaW5rIE1DUCBTZXJ2ZXJcbiAqIFxuICogVXNhZ2U6IG5wbSBydW4gY29uZmlndXJlXG4gKi9cblxuaW1wb3J0ICogYXMgcmVhZGxpbmUgZnJvbSAncmVhZGxpbmUnO1xuaW1wb3J0IHsgQ29uZmlnTWFuYWdlciB9IGZyb20gJy4vY29uZmlnLmpzJztcbmltcG9ydCB7IExpYnJlTGlua0NsaWVudCB9IGZyb20gJy4vbGlicmVsaW5rLWNsaWVudC5qcyc7XG5cbmNvbnN0IHJsID0gcmVhZGxpbmUuY3JlYXRlSW50ZXJmYWNlKHtcbiAgaW5wdXQ6IHByb2Nlc3Muc3RkaW4sXG4gIG91dHB1dDogcHJvY2Vzcy5zdGRvdXRcbn0pO1xuXG5mdW5jdGlvbiBxdWVzdGlvbihwcm9tcHQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgIHJsLnF1ZXN0aW9uKHByb21wdCwgKGFuc3dlcikgPT4ge1xuICAgICAgcmVzb2x2ZShhbnN3ZXIudHJpbSgpKTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHF1ZXN0aW9uSGlkZGVuKHByb21wdDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUocHJvbXB0KTtcbiAgICBcbiAgICBjb25zdCBzdGRpbiA9IHByb2Nlc3Muc3RkaW47XG4gICAgY29uc3Qgd2FzUmF3ID0gc3RkaW4uaXNSYXc7XG4gICAgXG4gICAgaWYgKHN0ZGluLmlzVFRZKSB7XG4gICAgICBzdGRpbi5zZXRSYXdNb2RlKHRydWUpO1xuICAgIH1cbiAgICBcbiAgICBsZXQgcGFzc3dvcmQgPSAnJztcbiAgICBcbiAgICBjb25zdCBvbkRhdGEgPSAoY2hhcjogQnVmZmVyKSA9PiB7XG4gICAgICBjb25zdCBjID0gY2hhci50b1N0cmluZygndXRmOCcpO1xuICAgICAgXG4gICAgICBzd2l0Y2ggKGMpIHtcbiAgICAgICAgY2FzZSAnXFxuJzpcbiAgICAgICAgY2FzZSAnXFxyJzpcbiAgICAgICAgY2FzZSAnXFx1MDAwNCc6XG4gICAgICAgICAgaWYgKHN0ZGluLmlzVFRZKSB7XG4gICAgICAgICAgICBzdGRpbi5zZXRSYXdNb2RlKHdhc1Jhdyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHN0ZGluLnJlbW92ZUxpc3RlbmVyKCdkYXRhJywgb25EYXRhKTtcbiAgICAgICAgICBjb25zb2xlLmxvZygnJyk7XG4gICAgICAgICAgcmVzb2x2ZShwYXNzd29yZCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ1xcdTAwMDMnOlxuICAgICAgICAgIHByb2Nlc3MuZXhpdCgpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdcXHUwMDdGJzpcbiAgICAgICAgY2FzZSAnXFxiJzpcbiAgICAgICAgICBwYXNzd29yZCA9IHBhc3N3b3JkLnNsaWNlKDAsIC0xKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBwYXNzd29yZCArPSBjO1xuICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKCcqJyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfTtcbiAgICBcbiAgICBzdGRpbi5vbignZGF0YScsIG9uRGF0YSk7XG4gICAgc3RkaW4ucmVzdW1lKCk7XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBtYWluKCkge1xuICBjb25zb2xlLmxvZygnJyk7XG4gIGNvbnNvbGUubG9nKCfwn6m4IExpYnJlTGluayBNQ1AgU2VydmVyIENvbmZpZ3VyYXRpb24nKTtcbiAgY29uc29sZS5sb2coJz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0nKTtcbiAgY29uc29sZS5sb2coJycpO1xuICBjb25zb2xlLmxvZygnVGhpcyB0b29sIHdpbGwgY29uZmlndXJlIHlvdXIgTGlicmVMaW5rIGNyZWRlbnRpYWxzLicpO1xuICBjb25zb2xlLmxvZygnWW91ciBjcmVkZW50aWFscyBhcmUgc3RvcmVkIGxvY2FsbHkgYXQgfi8ubGlicmVsaW5rLW1jcC9jb25maWcuanNvbicpO1xuICBjb25zb2xlLmxvZygnJyk7XG4gIGNvbnNvbGUubG9nKCfimqDvuI8gIElNUE9SVEFOVDogVXNlIHlvdXIgTGlicmVMaW5rVXAgY3JlZGVudGlhbHMgKG5vdCBMaWJyZUxpbmspJyk7XG4gIGNvbnNvbGUubG9nKCcgICAtIExpYnJlTGlua1VwIGlzIHRoZSBmb2xsb3dlci9zaGFyaW5nIGFwcCcpO1xuICBjb25zb2xlLmxvZygnICAgLSBNYWtlIHN1cmUgZGF0YSBzaGFyaW5nIGlzIGVuYWJsZWQgaW4gdGhlIExpYnJlTGluayBhcHAnKTtcbiAgY29uc29sZS5sb2coJycpO1xuXG4gIGNvbnN0IGNvbmZpZ01hbmFnZXIgPSBuZXcgQ29uZmlnTWFuYWdlcigpO1xuICBjb25zdCBjdXJyZW50Q29uZmlnID0gY29uZmlnTWFuYWdlci5nZXRDb25maWcoKTtcblxuICAvLyBHZXQgZW1haWxcbiAgY29uc3QgZW1haWxQcm9tcHQgPSBjdXJyZW50Q29uZmlnLmVtYWlsIFxuICAgID8gYEVtYWlsIFske2N1cnJlbnRDb25maWcuZW1haWx9XTogYCBcbiAgICA6ICdFbWFpbDogJztcbiAgbGV0IGVtYWlsID0gYXdhaXQgcXVlc3Rpb24oZW1haWxQcm9tcHQpO1xuICBpZiAoIWVtYWlsICYmIGN1cnJlbnRDb25maWcuZW1haWwpIHtcbiAgICBlbWFpbCA9IGN1cnJlbnRDb25maWcuZW1haWw7XG4gIH1cblxuICBpZiAoIWVtYWlsKSB7XG4gICAgY29uc29sZS5sb2coJ+KdjCBFbWFpbCBpcyByZXF1aXJlZCcpO1xuICAgIHJsLmNsb3NlKCk7XG4gICAgcHJvY2Vzcy5leGl0KDEpO1xuICB9XG5cbiAgLy8gR2V0IHBhc3N3b3JkXG4gIGNvbnNvbGUubG9nKCcnKTtcbiAgY29uc3QgcGFzc3dvcmQgPSBhd2FpdCBxdWVzdGlvbkhpZGRlbignUGFzc3dvcmQ6ICcpO1xuXG4gIGlmICghcGFzc3dvcmQpIHtcbiAgICBjb25zb2xlLmxvZygn4p2MIFBhc3N3b3JkIGlzIHJlcXVpcmVkJyk7XG4gICAgcmwuY2xvc2UoKTtcbiAgICBwcm9jZXNzLmV4aXQoMSk7XG4gIH1cblxuICAvLyBHZXQgcmVnaW9uXG4gIGNvbnNvbGUubG9nKCcnKTtcbiAgY29uc29sZS5sb2coJ1JlZ2lvbiBvcHRpb25zOicpO1xuICBjb25zb2xlLmxvZygnICBFVSAtIEV1cm9wZSAoZGVmYXVsdCknKTtcbiAgY29uc29sZS5sb2coJyAgVVMgLSBVbml0ZWQgU3RhdGVzJyk7XG4gIGNvbnNvbGUubG9nKCcgIERFIC0gR2VybWFueScpO1xuICBjb25zb2xlLmxvZygnICBGUiAtIEZyYW5jZScpO1xuICBjb25zb2xlLmxvZygnICBBUCAtIEFzaWEgUGFjaWZpYycpO1xuICBjb25zb2xlLmxvZygnICBBVSAtIEF1c3RyYWxpYScpO1xuICBjb25zb2xlLmxvZygnJyk7XG4gIFxuICBjb25zdCByZWdpb25Qcm9tcHQgPSBgUmVnaW9uIFske2N1cnJlbnRDb25maWcucmVnaW9ufV06IGA7XG4gIGxldCByZWdpb24gPSAoYXdhaXQgcXVlc3Rpb24ocmVnaW9uUHJvbXB0KSkudG9VcHBlckNhc2UoKSBhcyAnRVUnIHwgJ1VTJyB8ICdERScgfCAnRlInIHwgJ0FQJyB8ICdBVSc7XG4gIGlmICghcmVnaW9uKSB7XG4gICAgcmVnaW9uID0gY3VycmVudENvbmZpZy5yZWdpb247XG4gIH1cblxuICBjb25zdCB2YWxpZFJlZ2lvbnMgPSBbJ0VVJywgJ1VTJywgJ0RFJywgJ0ZSJywgJ0FQJywgJ0FVJ107XG4gIGlmICghdmFsaWRSZWdpb25zLmluY2x1ZGVzKHJlZ2lvbikpIHtcbiAgICBjb25zb2xlLmxvZyhg4p2MIEludmFsaWQgcmVnaW9uLiBNdXN0IGJlIG9uZSBvZjogJHt2YWxpZFJlZ2lvbnMuam9pbignLCAnKX1gKTtcbiAgICBybC5jbG9zZSgpO1xuICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgfVxuXG4gIC8vIEdldCB0YXJnZXQgcmFuZ2VzXG4gIGNvbnNvbGUubG9nKCcnKTtcbiAgY29uc29sZS5sb2coJ1RhcmdldCBnbHVjb3NlIHJhbmdlcyAobWcvZEwpOicpO1xuICBcbiAgY29uc3QgbG93UHJvbXB0ID0gYFRhcmdldCBMb3cgWyR7Y3VycmVudENvbmZpZy50YXJnZXRMb3d9XTogYDtcbiAgY29uc3QgbG93SW5wdXQgPSBhd2FpdCBxdWVzdGlvbihsb3dQcm9tcHQpO1xuICBjb25zdCB0YXJnZXRMb3cgPSBsb3dJbnB1dCA/IHBhcnNlSW50KGxvd0lucHV0LCAxMCkgOiBjdXJyZW50Q29uZmlnLnRhcmdldExvdztcblxuICBjb25zdCBoaWdoUHJvbXB0ID0gYFRhcmdldCBIaWdoIFske2N1cnJlbnRDb25maWcudGFyZ2V0SGlnaH1dOiBgO1xuICBjb25zdCBoaWdoSW5wdXQgPSBhd2FpdCBxdWVzdGlvbihoaWdoUHJvbXB0KTtcbiAgY29uc3QgdGFyZ2V0SGlnaCA9IGhpZ2hJbnB1dCA/IHBhcnNlSW50KGhpZ2hJbnB1dCwgMTApIDogY3VycmVudENvbmZpZy50YXJnZXRIaWdoO1xuXG4gIGlmICh0YXJnZXRMb3cgPj0gdGFyZ2V0SGlnaCkge1xuICAgIGNvbnNvbGUubG9nKCfinYwgVGFyZ2V0IGxvdyBtdXN0IGJlIGxlc3MgdGhhbiB0YXJnZXQgaGlnaCcpO1xuICAgIHJsLmNsb3NlKCk7XG4gICAgcHJvY2Vzcy5leGl0KDEpO1xuICB9XG5cbiAgLy8gU2F2ZSBjb25maWd1cmF0aW9uXG4gIGNvbnNvbGUubG9nKCcnKTtcbiAgY29uc29sZS5sb2coJ1NhdmluZyBjb25maWd1cmF0aW9uLi4uJyk7XG4gIFxuICB0cnkge1xuICAgIGNvbmZpZ01hbmFnZXIudXBkYXRlQ3JlZGVudGlhbHMoZW1haWwsIHBhc3N3b3JkKTtcbiAgICBjb25maWdNYW5hZ2VyLnVwZGF0ZVJlZ2lvbihyZWdpb24pO1xuICAgIGNvbmZpZ01hbmFnZXIudXBkYXRlUmFuZ2VzKHRhcmdldExvdywgdGFyZ2V0SGlnaCk7XG4gICAgY29uc29sZS5sb2coYOKchSBDb25maWd1cmF0aW9uIHNhdmVkIHRvICR7Y29uZmlnTWFuYWdlci5nZXRDb25maWdQYXRoKCl9YCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5sb2coYOKdjCBGYWlsZWQgdG8gc2F2ZSBjb25maWd1cmF0aW9uOiAke2Vycm9yfWApO1xuICAgIHJsLmNsb3NlKCk7XG4gICAgcHJvY2Vzcy5leGl0KDEpO1xuICB9XG5cbiAgLy8gVGVzdCBjb25uZWN0aW9uXG4gIGNvbnNvbGUubG9nKCcnKTtcbiAgY29uc29sZS5sb2coJ1Rlc3RpbmcgY29ubmVjdGlvbiB0byBMaWJyZUxpbmtVcC4uLicpO1xuICBcbiAgdHJ5IHtcbiAgICBjb25zdCBjbGllbnQgPSBuZXcgTGlicmVMaW5rQ2xpZW50KGNvbmZpZ01hbmFnZXIuZ2V0Q29uZmlnKCkpO1xuICAgIGF3YWl0IGNsaWVudC52YWxpZGF0ZUNvbm5lY3Rpb24oKTtcbiAgICBcbiAgICBjb25zb2xlLmxvZygn4pyFIENvbm5lY3Rpb24gc3VjY2Vzc2Z1bCEnKTtcbiAgICBcbiAgICBjb25zdCBnbHVjb3NlID0gYXdhaXQgY2xpZW50LmdldEN1cnJlbnRHbHVjb3NlKCk7XG4gICAgY29uc29sZS5sb2coJycpO1xuICAgIGNvbnNvbGUubG9nKCdDdXJyZW50IGdsdWNvc2UgcmVhZGluZzonKTtcbiAgICBjb25zb2xlLmxvZyhgICBWYWx1ZTogJHtnbHVjb3NlLnZhbHVlfSBtZy9kTGApO1xuICAgIGNvbnNvbGUubG9nKGAgIFRyZW5kOiAke2dsdWNvc2UudHJlbmR9YCk7XG4gICAgY29uc29sZS5sb2coYCAgU3RhdHVzOiAke2dsdWNvc2UuY29sb3IgPT09ICdncmVlbicgPyAnSW4gUmFuZ2UnIDogZ2x1Y29zZS5jb2xvciA9PT0gJ3JlZCcgPyAnQ3JpdGljYWwnIDogJ091dCBvZiBSYW5nZSd9YCk7XG4gICAgXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5sb2coYOKdjCBDb25uZWN0aW9uIGZhaWxlZDogJHtlcnJvcn1gKTtcbiAgICBjb25zb2xlLmxvZygnJyk7XG4gICAgY29uc29sZS5sb2coJ1Ryb3VibGVzaG9vdGluZzonKTtcbiAgICBjb25zb2xlLmxvZygnICAxLiBWZXJpZnkgeW91ciBlbWFpbCBhbmQgcGFzc3dvcmQgYXJlIGNvcnJlY3QnKTtcbiAgICBjb25zb2xlLmxvZygnICAyLiBNYWtlIHN1cmUgeW91IGFyZSB1c2luZyBMaWJyZUxpbmtVcCBjcmVkZW50aWFscycpO1xuICAgIGNvbnNvbGUubG9nKCcgIDMuIE9wZW4gdGhlIExpYnJlTGlua1VwIGFwcCBhbmQgYWNjZXB0IGFueSBUZXJtcyAmIENvbmRpdGlvbnMnKTtcbiAgICBjb25zb2xlLmxvZygnICA0LiBFbnN1cmUgc29tZW9uZSBpcyBzaGFyaW5nIGRhdGEgd2l0aCB5b3UgKG9yIHNoYXJlIHlvdXIgb3duIGRhdGEpJyk7XG4gICAgY29uc29sZS5sb2coJyAgNS4gQ2hlY2sgdGhhdCB5b3VyIHJlZ2lvbiBzZXR0aW5nIGlzIGNvcnJlY3QnKTtcbiAgICBybC5jbG9zZSgpO1xuICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgfVxuXG4gIGNvbnNvbGUubG9nKCcnKTtcbiAgY29uc29sZS5sb2coJ/CfjokgQ29uZmlndXJhdGlvbiBjb21wbGV0ZSEnKTtcbiAgY29uc29sZS5sb2coJycpO1xuICBjb25zb2xlLmxvZygnTmV4dCBzdGVwczonKTtcbiAgY29uc29sZS5sb2coJyAgMS4gQWRkIHRoZSBzZXJ2ZXIgdG8gQ2xhdWRlIERlc2t0b3AgY29uZmlndXJhdGlvbicpO1xuICBjb25zb2xlLmxvZygnICAyLiBSZXN0YXJ0IENsYXVkZSBEZXNrdG9wJyk7XG4gIGNvbnNvbGUubG9nKCcgIDMuIEFzayBDbGF1ZGUgYWJvdXQgeW91ciBnbHVjb3NlIGxldmVscyEnKTtcbiAgXG4gIHJsLmNsb3NlKCk7XG59XG5cbm1haW4oKS5jYXRjaCgoZXJyb3IpID0+IHtcbiAgY29uc29sZS5lcnJvcignRXJyb3I6JywgZXJyb3IpO1xuICBwcm9jZXNzLmV4aXQoMSk7XG59KTtcbiJdfQ==