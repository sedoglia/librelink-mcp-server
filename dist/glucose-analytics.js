/**
 * Glucose Analytics Module
 *
 * Calculates statistics, time-in-range, GMI, and pattern recognition
 */
export class GlucoseAnalytics {
    constructor(config) {
        this.config = config;
    }
    /**
     * Calculate comprehensive glucose statistics
     */
    calculateGlucoseStats(readings) {
        if (readings.length === 0) {
            return {
                average: 0,
                gmi: 0,
                timeInRange: 0,
                timeBelowRange: 0,
                timeAboveRange: 0,
                standardDeviation: 0,
                coefficientOfVariation: 0,
                readingCount: 0
            };
        }
        const values = readings.map(r => r.value);
        const n = values.length;
        // Calculate average
        const sum = values.reduce((a, b) => a + b, 0);
        const average = sum / n;
        // Calculate standard deviation
        const squaredDiffs = values.map(v => Math.pow(v - average, 2));
        const avgSquaredDiff = squaredDiffs.reduce((a, b) => a + b, 0) / n;
        const standardDeviation = Math.sqrt(avgSquaredDiff);
        // Calculate coefficient of variation
        const coefficientOfVariation = (standardDeviation / average) * 100;
        // Calculate GMI (Glucose Management Indicator)
        // GMI = 3.31 + 0.02392 Ã— [mean glucose in mg/dL]
        const gmi = 3.31 + (0.02392 * average);
        // Calculate time in range
        const inRange = values.filter(v => v >= this.config.targetLow && v <= this.config.targetHigh).length;
        const belowRange = values.filter(v => v < this.config.targetLow).length;
        const aboveRange = values.filter(v => v > this.config.targetHigh).length;
        const timeInRange = (inRange / n) * 100;
        const timeBelowRange = (belowRange / n) * 100;
        const timeAboveRange = (aboveRange / n) * 100;
        return {
            average: Math.round(average * 100) / 100,
            gmi: Math.round(gmi * 100) / 100,
            timeInRange: Math.round(timeInRange * 100) / 100,
            timeBelowRange: Math.round(timeBelowRange * 100) / 100,
            timeAboveRange: Math.round(timeAboveRange * 100) / 100,
            standardDeviation: Math.round(standardDeviation * 100) / 100,
            coefficientOfVariation: Math.round(coefficientOfVariation * 100) / 100,
            readingCount: n
        };
    }
    /**
     * Analyze glucose trends and patterns
     */
    analyzeTrends(readings, period) {
        const patterns = [];
        let dawnPhenomenon = false;
        let mealResponse = 0;
        let overnightStability = 0;
        if (readings.length === 0) {
            return { patterns, dawnPhenomenon, mealResponse, overnightStability };
        }
        // Group readings by hour of day
        const byHour = this.groupByHour(readings);
        // Check for dawn phenomenon (rise between 3am-8am)
        dawnPhenomenon = this.detectDawnPhenomenon(byHour);
        if (dawnPhenomenon) {
            patterns.push('Dawn phenomenon detected - glucose rises in early morning');
        }
        // Calculate overnight stability (10pm-6am)
        overnightStability = this.calculateOvernightStability(byHour);
        if (overnightStability < 10) {
            patterns.push('Excellent overnight glucose stability');
        }
        else if (overnightStability < 20) {
            patterns.push('Good overnight glucose stability');
        }
        else {
            patterns.push('Variable overnight glucose - consider reviewing evening routine');
        }
        // Analyze meal responses (approximate based on typical meal times)
        mealResponse = this.analyzeMealResponse(byHour);
        if (mealResponse < 30) {
            patterns.push('Good postprandial glucose control');
        }
        else if (mealResponse < 50) {
            patterns.push('Moderate postprandial glucose rises');
        }
        else {
            patterns.push('High postprandial glucose spikes - consider meal composition');
        }
        // Check time in range trend
        const stats = this.calculateGlucoseStats(readings);
        if (stats.timeInRange >= 70) {
            patterns.push(`Excellent time in range: ${stats.timeInRange.toFixed(1)}%`);
        }
        else if (stats.timeInRange >= 50) {
            patterns.push(`Good time in range: ${stats.timeInRange.toFixed(1)}%`);
        }
        else {
            patterns.push(`Time in range needs improvement: ${stats.timeInRange.toFixed(1)}%`);
        }
        // Check variability
        if (stats.coefficientOfVariation < 33) {
            patterns.push('Low glucose variability - stable control');
        }
        else {
            patterns.push('High glucose variability - consider consistency improvements');
        }
        return {
            patterns,
            dawnPhenomenon,
            mealResponse: Math.round(mealResponse * 100) / 100,
            overnightStability: Math.round(overnightStability * 100) / 100
        };
    }
    /**
     * Group readings by hour of day
     */
    groupByHour(readings) {
        const byHour = new Map();
        for (let i = 0; i < 24; i++) {
            byHour.set(i, []);
        }
        for (const reading of readings) {
            const hour = new Date(reading.timestamp).getHours();
            const values = byHour.get(hour) || [];
            values.push(reading.value);
            byHour.set(hour, values);
        }
        return byHour;
    }
    /**
     * Detect dawn phenomenon
     */
    detectDawnPhenomenon(byHour) {
        // Get average for early morning (3-4am) and later morning (6-8am)
        const earlyMorning = [];
        const laterMorning = [];
        for (let h = 3; h <= 4; h++) {
            earlyMorning.push(...(byHour.get(h) || []));
        }
        for (let h = 6; h <= 8; h++) {
            laterMorning.push(...(byHour.get(h) || []));
        }
        if (earlyMorning.length === 0 || laterMorning.length === 0) {
            return false;
        }
        const earlyAvg = earlyMorning.reduce((a, b) => a + b, 0) / earlyMorning.length;
        const laterAvg = laterMorning.reduce((a, b) => a + b, 0) / laterMorning.length;
        // Dawn phenomenon if later morning is significantly higher (>20 mg/dL)
        return (laterAvg - earlyAvg) > 20;
    }
    /**
     * Calculate overnight stability (standard deviation of overnight readings)
     */
    calculateOvernightStability(byHour) {
        const overnightValues = [];
        // 10pm-6am
        for (let h = 22; h <= 23; h++) {
            overnightValues.push(...(byHour.get(h) || []));
        }
        for (let h = 0; h <= 6; h++) {
            overnightValues.push(...(byHour.get(h) || []));
        }
        if (overnightValues.length < 2) {
            return 0;
        }
        const avg = overnightValues.reduce((a, b) => a + b, 0) / overnightValues.length;
        const squaredDiffs = overnightValues.map(v => Math.pow(v - avg, 2));
        const variance = squaredDiffs.reduce((a, b) => a + b, 0) / overnightValues.length;
        return Math.sqrt(variance);
    }
    /**
     * Analyze meal response (glucose rise after typical meal times)
     */
    analyzeMealResponse(byHour) {
        const mealTimes = [
            { before: [6, 7], after: [8, 9] }, // Breakfast
            { before: [11, 12], after: [13, 14] }, // Lunch
            { before: [17, 18], after: [19, 20] } // Dinner
        ];
        const rises = [];
        for (const meal of mealTimes) {
            const beforeValues = [];
            const afterValues = [];
            for (const h of meal.before) {
                beforeValues.push(...(byHour.get(h) || []));
            }
            for (const h of meal.after) {
                afterValues.push(...(byHour.get(h) || []));
            }
            if (beforeValues.length > 0 && afterValues.length > 0) {
                const beforeAvg = beforeValues.reduce((a, b) => a + b, 0) / beforeValues.length;
                const afterAvg = afterValues.reduce((a, b) => a + b, 0) / afterValues.length;
                rises.push(Math.max(0, afterAvg - beforeAvg));
            }
        }
        if (rises.length === 0) {
            return 0;
        }
        return rises.reduce((a, b) => a + b, 0) / rises.length;
    }
    /**
     * Update configuration
     */
    updateConfig(newConfig) {
        this.config = { ...this.config, ...newConfig };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2x1Y29zZS1hbmFseXRpY3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZ2x1Y29zZS1hbmFseXRpY3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7R0FJRztBQUlILE1BQU0sT0FBTyxnQkFBZ0I7SUFHM0IsWUFBWSxNQUF1QjtRQUNqQyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztJQUN2QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxxQkFBcUIsQ0FBQyxRQUEwQjtRQUM5QyxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDMUIsT0FBTztnQkFDTCxPQUFPLEVBQUUsQ0FBQztnQkFDVixHQUFHLEVBQUUsQ0FBQztnQkFDTixXQUFXLEVBQUUsQ0FBQztnQkFDZCxjQUFjLEVBQUUsQ0FBQztnQkFDakIsY0FBYyxFQUFFLENBQUM7Z0JBQ2pCLGlCQUFpQixFQUFFLENBQUM7Z0JBQ3BCLHNCQUFzQixFQUFFLENBQUM7Z0JBQ3pCLFlBQVksRUFBRSxDQUFDO2FBQ2hCLENBQUM7UUFDSixDQUFDO1FBRUQsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMxQyxNQUFNLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO1FBRXhCLG9CQUFvQjtRQUNwQixNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUM5QyxNQUFNLE9BQU8sR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBRXhCLCtCQUErQjtRQUMvQixNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFD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RUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztJQUN6RCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxZQUFZLENBQUMsU0FBbUM7UUFDOUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLFNBQVMsRUFBRSxDQUFDO0lBQ2pELENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogR2x1Y29zZSBBbmFseXRpY3MgTW9kdWxlXG4gKiBcbiAqIENhbGN1bGF0ZXMgc3RhdGlzdGljcywgdGltZS1pbi1yYW5nZSwgR01JLCBhbmQgcGF0dGVybiByZWNvZ25pdGlvblxuICovXG5cbmltcG9ydCB7IEdsdWNvc2VSZWFkaW5nLCBHbHVjb3NlU3RhdHMsIEdsdWNvc2VUcmVuZHMsIExpYnJlTGlua0NvbmZpZyB9IGZyb20gJy4vdHlwZXMuanMnO1xuXG5leHBvcnQgY2xhc3MgR2x1Y29zZUFuYWx5dGljcyB7XG4gIHByaXZhdGUgY29uZmlnOiBMaWJyZUxpbmtDb25maWc7XG5cbiAgY29uc3RydWN0b3IoY29uZmlnOiBMaWJyZUxpbmtDb25maWcpIHtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGUgY29tcHJlaGVuc2l2ZSBnbHVjb3NlIHN0YXRpc3RpY3NcbiAgICovXG4gIGNhbGN1bGF0ZUdsdWNvc2VTdGF0cyhyZWFkaW5nczogR2x1Y29zZVJlYWRpbmdbXSk6IEdsdWNvc2VTdGF0cyB7XG4gICAgaWYgKHJlYWRpbmdzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgYXZlcmFnZTogMCxcbiAgICAgICAgZ21pOiAwLFxuICAgICAgICB0aW1lSW5SYW5nZTogMCxcbiAgICAgICAgdGltZUJlbG93UmFuZ2U6IDAsXG4gICAgICAgIHRpbWVBYm92ZVJhbmdlOiAwLFxuICAgICAgICBzdGFuZGFyZERldmlhdGlvbjogMCxcbiAgICAgICAgY29lZmZpY2llbnRPZlZhcmlhdGlvbjogMCxcbiAgICAgICAgcmVhZGluZ0NvdW50OiAwXG4gICAgICB9O1xuICAgIH1cblxuICAgIGNvbnN0IHZhbHVlcyA9IHJlYWRpbmdzLm1hcChyID0+IHIudmFsdWUpO1xuICAgIGNvbnN0IG4gPSB2YWx1ZXMubGVuZ3RoO1xuXG4gICAgLy8gQ2FsY3VsYXRlIGF2ZXJhZ2VcbiAgICBjb25zdCBzdW0gPSB2YWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7XG4gICAgY29uc3QgYXZlcmFnZSA9IHN1bSAvIG47XG5cbiAgICAvLyBDYWxjdWxhdGUgc3RhbmRhcmQgZGV2aWF0aW9uXG4gICAgY29uc3Qgc3F1YXJlZERpZmZzID0gdmFsdWVzLm1hcCh2ID0+IE1hdGgucG93KHYgLSBhdmVyYWdlLCAyKSk7XG4gICAgY29uc3QgYXZnU3F1YXJlZERpZmYgPSBzcXVhcmVkRGlmZnMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBuO1xuICAgIGNvbnN0IHN0YW5kYXJkRGV2aWF0aW9uID0gTWF0aC5zcXJ0KGF2Z1NxdWFyZWREaWZmKTtcblxuICAgIC8vIENhbGN1bGF0ZSBjb2VmZmljaWVudCBvZiB2YXJpYXRpb25cbiAgICBjb25zdCBjb2VmZmljaWVudE9mVmFyaWF0aW9uID0gKHN0YW5kYXJkRGV2aWF0aW9uIC8gYXZlcmFnZSkgKiAxMDA7XG5cbiAgICAvLyBDYWxjdWxhdGUgR01JIChHbHVjb3NlIE1hbmFnZW1lbnQgSW5kaWNhdG9yKVxuICAgIC8vIEdNSSA9IDMuMzEgKyAwLjAyMzkyIMOXIFttZWFuIGdsdWNvc2UgaW4gbWcvZExdXG4gICAgY29uc3QgZ21pID0gMy4zMSArICgwLjAyMzkyICogYXZlcmFnZSk7XG5cbiAgICAvLyBDYWxjdWxhdGUgdGltZSBpbiByYW5nZVxuICAgIGNvbnN0IGluUmFuZ2UgPSB2YWx1ZXMuZmlsdGVyKHYgPT4gdiA+PSB0aGlzLmNvbmZpZy50YXJnZXRMb3cgJiYgdiA8PSB0aGlzLmNvbmZpZy50YXJnZXRIaWdoKS5sZW5ndGg7XG4gICAgY29uc3QgYmVsb3dSYW5nZSA9IHZhbHVlcy5maWx0ZXIodiA9PiB2IDwgdGhpcy5jb25maWcudGFyZ2V0TG93KS5sZW5ndGg7XG4gICAgY29uc3QgYWJvdmVSYW5nZSA9IHZhbHVlcy5maWx0ZXIodiA9PiB2ID4gdGhpcy5jb25maWcudGFyZ2V0SGlnaCkubGVuZ3RoO1xuXG4gICAgY29uc3QgdGltZUluUmFuZ2UgPSAoaW5SYW5nZSAvIG4pICogMTAwO1xuICAgIGNvbnN0IHRpbWVCZWxvd1JhbmdlID0gKGJlbG93UmFuZ2UgLyBuKSAqIDEwMDtcbiAgICBjb25zdCB0aW1lQWJvdmVSYW5nZSA9IChhYm92ZVJhbmdlIC8gbikgKiAxMDA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgYXZlcmFnZTogTWF0aC5yb3VuZChhdmVyYWdlICogMTAwKSAvIDEwMCxcbiAgICAgIGdtaTogTWF0aC5yb3VuZChnbWkgKiAxMDApIC8gMTAwLFxuICAgICAgdGltZUluUmFuZ2U6IE1hdGgucm91bmQodGltZUluUmFuZ2UgKiAxMDApIC8gMTAwLFxuICAgICAgdGltZUJlbG93UmFuZ2U6IE1hdGgucm91bmQodGltZUJlbG93UmFuZ2UgKiAxMDApIC8gMTAwLFxuICAgICAgdGltZUFib3ZlUmFuZ2U6IE1hdGgucm91bmQodGltZUFib3ZlUmFuZ2UgKiAxMDApIC8gMTAwLFxuICAgICAgc3RhbmRhcmREZXZpYXRpb246IE1hdGgucm91bmQoc3RhbmRhcmREZXZpYXRpb24gKiAxMDApIC8gMTAwLFxuICAgICAgY29lZmZpY2llbnRPZlZhcmlhdGlvbjogTWF0aC5yb3VuZChjb2VmZmljaWVudE9mVmFyaWF0aW9uICogMTAwKSAvIDEwMCxcbiAgICAgIHJlYWRpbmdDb3VudDogblxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQW5hbHl6ZSBnbHVjb3NlIHRyZW5kcyBhbmQgcGF0dGVybnNcbiAgICovXG4gIGFuYWx5emVUcmVuZHMocmVhZGluZ3M6IEdsdWNvc2VSZWFkaW5nW10sIHBlcmlvZDogJ2RhaWx5JyB8ICd3ZWVrbHknIHwgJ21vbnRobHknKTogR2x1Y29zZVRyZW5kcyB7XG4gICAgY29uc3QgcGF0dGVybnM6IHN0cmluZ1tdID0gW107XG4gICAgbGV0IGRhd25QaGVub21lbm9uID0gZmFsc2U7XG4gICAgbGV0IG1lYWxSZXNwb25zZSA9IDA7XG4gICAgbGV0IG92ZXJuaWdodFN0YWJpbGl0eSA9IDA7XG5cbiAgICBpZiAocmVhZGluZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4geyBwYXR0ZXJucywgZGF3blBoZW5vbWVub24sIG1lYWxSZXNwb25zZSwgb3Zlcm5pZ2h0U3RhYmlsaXR5IH07XG4gICAgfVxuXG4gICAgLy8gR3JvdXAgcmVhZGluZ3MgYnkgaG91ciBvZiBkYXlcbiAgICBjb25zdCBieUhvdXIgPSB0aGlzLmdyb3VwQnlIb3VyKHJlYWRpbmdzKTtcblxuICAgIC8vIENoZWNrIGZvciBkYXduIHBoZW5vbWVub24gKHJpc2UgYmV0d2VlbiAzYW0tOGFtKVxuICAgIGRhd25QaGVub21lbm9uID0gdGhpcy5kZXRlY3REYXduUGhlbm9tZW5vbihieUhvdXIpO1xuICAgIGlmIChkYXduUGhlbm9tZW5vbikge1xuICAgICAgcGF0dGVybnMucHVzaCgnRGF3biBwaGVub21lbm9uIGRldGVjdGVkIC0gZ2x1Y29zZSByaXNlcyBpbiBlYXJseSBtb3JuaW5nJyk7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXRlIG92ZXJuaWdodCBzdGFiaWxpdHkgKDEwcG0tNmFtKVxuICAgIG92ZXJuaWdodFN0YWJpbGl0eSA9IHRoaXMuY2FsY3VsYXRlT3Zlcm5pZ2h0U3RhYmlsaXR5KGJ5SG91cik7XG4gICAgaWYgKG92ZXJuaWdodFN0YWJpbGl0eSA8IDEwKSB7XG4gICAgICBwYXR0ZXJucy5wdXNoKCdFeGNlbGxlbnQgb3Zlcm5pZ2h0IGdsdWNvc2Ugc3RhYmlsaXR5Jyk7XG4gICAgfSBlbHNlIGlmIChvdmVybmlnaHRTdGFiaWxpdHkgPCAyMCkge1xuICAgICAgcGF0dGVybnMucHVzaCgnR29vZCBvdmVybmlnaHQgZ2x1Y29zZSBzdGFiaWxpdHknKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGF0dGVybnMucHVzaCgnVmFyaWFibGUgb3Zlcm5pZ2h0IGdsdWNvc2UgLSBjb25zaWRlciByZXZpZXdpbmcgZXZlbmluZyByb3V0aW5lJyk7XG4gICAgfVxuXG4gICAgLy8gQW5hbHl6ZSBtZWFsIHJlc3BvbnNlcyAoYXBwcm94aW1hdGUgYmFzZWQgb24gdHlwaWNhbCBtZWFsIHRpbWVzKVxuICAgIG1lYWxSZXNwb25zZSA9IHRoaXMuYW5hbHl6ZU1lYWxSZXNwb25zZShieUhvdXIpO1xuICAgIGlmIChtZWFsUmVzcG9uc2UgPCAzMCkge1xuICAgICAgcGF0dGVybnMucHVzaCgnR29vZCBwb3N0cHJhbmRpYWwgZ2x1Y29zZSBjb250cm9sJyk7XG4gICAgfSBlbHNlIGlmIChtZWFsUmVzcG9uc2UgPCA1MCkge1xuICAgICAgcGF0dGVybnMucHVzaCgnTW9kZXJhdGUgcG9zdHByYW5kaWFsIGdsdWNvc2UgcmlzZXMnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGF0dGVybnMucHVzaCgnSGlnaCBwb3N0cHJhbmRpYWwgZ2x1Y29zZSBzcGlrZXMgLSBjb25zaWRlciBtZWFsIGNvbXBvc2l0aW9uJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgdGltZSBpbiByYW5nZSB0cmVuZFxuICAgIGNvbnN0IHN0YXRzID0gdGhpcy5jYWxjdWxhdGVHbHVjb3NlU3RhdHMocmVhZGluZ3MpO1xuICAgIGlmIChzdGF0cy50aW1lSW5SYW5nZSA+PSA3MCkge1xuICAgICAgcGF0dGVybnMucHVzaChgRXhjZWxsZW50IHRpbWUgaW4gcmFuZ2U6ICR7c3RhdHMudGltZUluUmFuZ2UudG9GaXhlZCgxKX0lYCk7XG4gICAgfSBlbHNlIGlmIChzdGF0cy50aW1lSW5SYW5nZSA+PSA1MCkge1xuICAgICAgcGF0dGVybnMucHVzaChgR29vZCB0aW1lIGluIHJhbmdlOiAke3N0YXRzLnRpbWVJblJhbmdlLnRvRml4ZWQoMSl9JWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXR0ZXJucy5wdXNoKGBUaW1lIGluIHJhbmdlIG5lZWRzIGltcHJvdmVtZW50OiAke3N0YXRzLnRpbWVJblJhbmdlLnRvRml4ZWQoMSl9JWApO1xuICAgIH1cblxuICAgIC8vIENoZWNrIHZhcmlhYmlsaXR5XG4gICAgaWYgKHN0YXRzLmNvZWZmaWNpZW50T2ZWYXJpYXRpb24gPCAzMykge1xuICAgICAgcGF0dGVybnMucHVzaCgnTG93IGdsdWNvc2UgdmFyaWFiaWxpdHkgLSBzdGFibGUgY29udHJvbCcpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXR0ZXJucy5wdXNoKCdIaWdoIGdsdWNvc2UgdmFyaWFiaWxpdHkgLSBjb25zaWRlciBjb25zaXN0ZW5jeSBpbXByb3ZlbWVudHMnKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgcGF0dGVybnMsXG4gICAgICBkYXduUGhlbm9tZW5vbixcbiAgICAgIG1lYWxSZXNwb25zZTogTWF0aC5yb3VuZChtZWFsUmVzcG9uc2UgKiAxMDApIC8gMTAwLFxuICAgICAgb3Zlcm5pZ2h0U3RhYmlsaXR5OiBNYXRoLnJvdW5kKG92ZXJuaWdodFN0YWJpbGl0eSAqIDEwMCkgLyAxMDBcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdyb3VwIHJlYWRpbmdzIGJ5IGhvdXIgb2YgZGF5XG4gICAqL1xuICBwcml2YXRlIGdyb3VwQnlIb3VyKHJlYWRpbmdzOiBHbHVjb3NlUmVhZGluZ1tdKTogTWFwPG51bWJlciwgbnVtYmVyW10+IHtcbiAgICBjb25zdCBieUhvdXIgPSBuZXcgTWFwPG51bWJlciwgbnVtYmVyW10+KCk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDI0OyBpKyspIHtcbiAgICAgIGJ5SG91ci5zZXQoaSwgW10pO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgcmVhZGluZyBvZiByZWFkaW5ncykge1xuICAgICAgY29uc3QgaG91ciA9IG5ldyBEYXRlKHJlYWRpbmcudGltZXN0YW1wKS5nZXRIb3VycygpO1xuICAgICAgY29uc3QgdmFsdWVzID0gYnlIb3VyLmdldChob3VyKSB8fCBbXTtcbiAgICAgIHZhbHVlcy5wdXNoKHJlYWRpbmcudmFsdWUpO1xuICAgICAgYnlIb3VyLnNldChob3VyLCB2YWx1ZXMpO1xuICAgIH1cblxuICAgIHJldHVybiBieUhvdXI7XG4gIH1cblxuICAvKipcbiAgICogRGV0ZWN0IGRhd24gcGhlbm9tZW5vblxuICAgKi9cbiAgcHJpdmF0ZSBkZXRlY3REYXduUGhlbm9tZW5vbihieUhvdXI6IE1hcDxudW1iZXIsIG51bWJlcltdPik6IGJvb2xlYW4ge1xuICAgIC8vIEdldCBhdmVyYWdlIGZvciBlYXJseSBtb3JuaW5nICgzLTRhbSkgYW5kIGxhdGVyIG1vcm5pbmcgKDYtOGFtKVxuICAgIGNvbnN0IGVhcmx5TW9ybmluZzogbnVtYmVyW10gPSBbXTtcbiAgICBjb25zdCBsYXRlck1vcm5pbmc6IG51bWJlcltdID0gW107XG5cbiAgICBmb3IgKGxldCBoID0gMzsgaCA8PSA0OyBoKyspIHtcbiAgICAgIGVhcmx5TW9ybmluZy5wdXNoKC4uLihieUhvdXIuZ2V0KGgpIHx8IFtdKSk7XG4gICAgfVxuXG4gICAgZm9yIChsZXQgaCA9IDY7IGggPD0gODsgaCsrKSB7XG4gICAgICBsYXRlck1vcm5pbmcucHVzaCguLi4oYnlIb3VyLmdldChoKSB8fCBbXSkpO1xuICAgIH1cblxuICAgIGlmIChlYXJseU1vcm5pbmcubGVuZ3RoID09PSAwIHx8IGxhdGVyTW9ybmluZy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBlYXJseUF2ZyA9IGVhcmx5TW9ybmluZy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIGVhcmx5TW9ybmluZy5sZW5ndGg7XG4gICAgY29uc3QgbGF0ZXJBdmcgPSBsYXRlck1vcm5pbmcucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBsYXRlck1vcm5pbmcubGVuZ3RoO1xuXG4gICAgLy8gRGF3biBwaGVub21lbm9uIGlmIGxhdGVyIG1vcm5pbmcgaXMgc2lnbmlmaWNhbnRseSBoaWdoZXIgKD4yMCBtZy9kTClcbiAgICByZXR1cm4gKGxhdGVyQXZnIC0gZWFybHlBdmcpID4gMjA7XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYXRlIG92ZXJuaWdodCBzdGFiaWxpdHkgKHN0YW5kYXJkIGRldmlhdGlvbiBvZiBvdmVybmlnaHQgcmVhZGluZ3MpXG4gICAqL1xuICBwcml2YXRlIGNhbGN1bGF0ZU92ZXJuaWdodFN0YWJpbGl0eShieUhvdXI6IE1hcDxudW1iZXIsIG51bWJlcltdPik6IG51bWJlciB7XG4gICAgY29uc3Qgb3Zlcm5pZ2h0VmFsdWVzOiBudW1iZXJbXSA9IFtdO1xuXG4gICAgLy8gMTBwbS02YW1cbiAgICBmb3IgKGxldCBoID0gMjI7IGggPD0gMjM7IGgrKykge1xuICAgICAgb3Zlcm5pZ2h0VmFsdWVzLnB1c2goLi4uKGJ5SG91ci5nZXQoaCkgfHwgW10pKTtcbiAgICB9XG4gICAgZm9yIChsZXQgaCA9IDA7IGggPD0gNjsgaCsrKSB7XG4gICAgICBvdmVybmlnaHRWYWx1ZXMucHVzaCguLi4oYnlIb3VyLmdldChoKSB8fCBbXSkpO1xuICAgIH1cblxuICAgIGlmIChvdmVybmlnaHRWYWx1ZXMubGVuZ3RoIDwgMikge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuXG4gICAgY29uc3QgYXZnID0gb3Zlcm5pZ2h0VmFsdWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gb3Zlcm5pZ2h0VmFsdWVzLmxlbmd0aDtcbiAgICBjb25zdCBzcXVhcmVkRGlmZnMgPSBvdmVybmlnaHRWYWx1ZXMubWFwKHYgPT4gTWF0aC5wb3codiAtIGF2ZywgMikpO1xuICAgIGNvbnN0IHZhcmlhbmNlID0gc3F1YXJlZERpZmZzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gb3Zlcm5pZ2h0VmFsdWVzLmxlbmd0aDtcblxuICAgIHJldHVybiBNYXRoLnNxcnQodmFyaWFuY2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFuYWx5emUgbWVhbCByZXNwb25zZSAoZ2x1Y29zZSByaXNlIGFmdGVyIHR5cGljYWwgbWVhbCB0aW1lcylcbiAgICovXG4gIHByaXZhdGUgYW5hbHl6ZU1lYWxSZXNwb25zZShieUhvdXI6IE1hcDxudW1iZXIsIG51bWJlcltdPik6IG51bWJlciB7XG4gICAgY29uc3QgbWVhbFRpbWVzID0gW1xuICAgICAgeyBiZWZvcmU6IFs2LCA3XSwgYWZ0ZXI6IFs4LCA5XSB9LCAgICAgIC8vIEJyZWFrZmFzdFxuICAgICAgeyBiZWZvcmU6IFsxMSwgMTJdLCBhZnRlcjogWzEzLCAxNF0gfSwgIC8vIEx1bmNoXG4gICAgICB7IGJlZm9yZTogWzE3LCAxOF0sIGFmdGVyOiBbMTksIDIwXSB9ICAgLy8gRGlubmVyXG4gICAgXTtcblxuICAgIGNvbnN0IHJpc2VzOiBudW1iZXJbXSA9IFtdO1xuXG4gICAgZm9yIChjb25zdCBtZWFsIG9mIG1lYWxUaW1lcykge1xuICAgICAgY29uc3QgYmVmb3JlVmFsdWVzOiBudW1iZXJbXSA9IFtdO1xuICAgICAgY29uc3QgYWZ0ZXJWYWx1ZXM6IG51bWJlcltdID0gW107XG5cbiAgICAgIGZvciAoY29uc3QgaCBvZiBtZWFsLmJlZm9yZSkge1xuICAgICAgICBiZWZvcmVWYWx1ZXMucHVzaCguLi4oYnlIb3VyLmdldChoKSB8fCBbXSkpO1xuICAgICAgfVxuICAgICAgZm9yIChjb25zdCBoIG9mIG1lYWwuYWZ0ZXIpIHtcbiAgICAgICAgYWZ0ZXJWYWx1ZXMucHVzaCguLi4oYnlIb3VyLmdldChoKSB8fCBbXSkpO1xuICAgICAgfVxuXG4gICAgICBpZiAoYmVmb3JlVmFsdWVzLmxlbmd0aCA+IDAgJiYgYWZ0ZXJWYWx1ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBiZWZvcmVBdmcgPSBiZWZvcmVWYWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBiZWZvcmVWYWx1ZXMubGVuZ3RoO1xuICAgICAgICBjb25zdCBhZnRlckF2ZyA9IGFmdGVyVmFsdWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gYWZ0ZXJWYWx1ZXMubGVuZ3RoO1xuICAgICAgICByaXNlcy5wdXNoKE1hdGgubWF4KDAsIGFmdGVyQXZnIC0gYmVmb3JlQXZnKSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHJpc2VzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJpc2VzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gcmlzZXMubGVuZ3RoO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBjb25maWd1cmF0aW9uXG4gICAqL1xuICB1cGRhdGVDb25maWcobmV3Q29uZmlnOiBQYXJ0aWFsPExpYnJlTGlua0NvbmZpZz4pOiB2b2lkIHtcbiAgICB0aGlzLmNvbmZpZyA9IHsgLi4udGhpcy5jb25maWcsIC4uLm5ld0NvbmZpZyB9O1xuICB9XG59XG4iXX0=